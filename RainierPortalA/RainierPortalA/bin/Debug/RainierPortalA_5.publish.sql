/*
Deployment script for RainierPortalA

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "RainierPortalA"
:setvar DefaultFilePrefix "RainierPortalA"
:setvar DefaultDataPath "D:\SQLDATA16\"
:setvar DefaultLogPath "E:\SQLLOG16\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Dropping [dbo].[RefPatient2]...';


GO
ALTER TABLE [dbo].[PatientDevice] DROP CONSTRAINT [RefPatient2];


GO
PRINT N'Dropping [dbo].[FK_Encounter_Patient_PatientID]...';


GO
ALTER TABLE [dbo].[Encounter] DROP CONSTRAINT [FK_Encounter_Patient_PatientID];


GO
PRINT N'Dropping [dbo].[PK_Patient_PatientID]...';


GO
ALTER TABLE [dbo].[Patient] DROP CONSTRAINT [PK_Patient_PatientID];


GO
PRINT N'Creating [dbo].[Event]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO
CREATE TABLE [dbo].[Event] (
    [EventID]   INT       NOT NULL,
    [Timestamp] TIMESTAMP NOT NULL,
    CONSTRAINT [PK_Event_EventID] PRIMARY KEY CLUSTERED ([EventID] ASC)
);


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Creating [dbo].[PK_Patient_PatientID]...';


GO
ALTER TABLE [dbo].[Patient]
    ADD CONSTRAINT [PK_Patient_PatientID] PRIMARY KEY CLUSTERED ([PatientID] ASC) WITH (FILLFACTOR = 100);


GO
PRINT N'Creating [dbo].[RefPatient2]...';


GO
ALTER TABLE [dbo].[PatientDevice] WITH NOCHECK
    ADD CONSTRAINT [RefPatient2] FOREIGN KEY ([PatientID]) REFERENCES [dbo].[Patient] ([PatientID]);


GO
PRINT N'Creating [dbo].[FK_Encounter_Patient_PatientID]...';


GO
ALTER TABLE [dbo].[Encounter] WITH NOCHECK
    ADD CONSTRAINT [FK_Encounter_Patient_PatientID] FOREIGN KEY ([PatientID]) REFERENCES [dbo].[Patient] ([PatientID]);


GO
PRINT N'Creating [dbo].[Event].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'All events are formally defined.  They don''t leave it up to individual clients to infer an event from various property changes.  Examples of events

    Admit, Discharge,Transfer , P2DAssociate, P2DDisassocate

Events are what is stored for retrospective data - think an event log as  stream of events.    Devices, Patients, and Org''s will have event logs.

OPEN issue:  How to get the current state of object (eg Alarm) from a event log.  
1) either capture entire state of object with every event (storage/net bloat?) or 
2) Send periodic checkpoints  then the current state can be reconstructed by apply deltas to last checkpoint.   
Option 1 may constrain the logical design of an object (implementation details on property size''s) ,  Option 2 is extra coding someplace.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Event';


GO
PRINT N'Creating [dbo].[DeviceSession].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'A period of monitoring by a device.

    There is always an active session on a device.

    The session may or may not have a patient associated (Encounter) with it.  An anonymous session is a session with no associated patient. 

    When a patient is associated with device a new session is created (and the previous one ended)

    When a patient is dis-associated the active session is ended and new one created with no associated patient.

    The Clinical Mgmt Web App can be used to reconcile sessions with patients. For example it was known that a anonymous session actually had John Doe associated with it then it can be retroactively associated with John Doe.    Sessions can be split and merged to retroactively  fix up inconsistencies with P2DA.  
', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'DeviceSession';


GO
PRINT N'Creating [dbo].[Encounter].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'From IHE: An interaction between a patient and care provider(s) for the purpose of providing healthcare-related service(s). Healthcare services include health assessment. For example, outpatient visit to multiple departments, home health support (including physical therapy), inpatient hospital stay, emergency room visit, field visit (e.g., traffic accident), office visit, occupational therapy, telephone call.


    An encounter is created on Admit and remains until Discharge.

    A patient is always in a bed.   Not such thing as patient without a bed.

    A Transfer is just changing beds.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'Encounter';


GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[PatientDevice] WITH CHECK CHECK CONSTRAINT [RefPatient2];

ALTER TABLE [dbo].[Encounter] WITH CHECK CHECK CONSTRAINT [FK_Encounter_Patient_PatientID];


GO
PRINT N'Update complete.';


GO
