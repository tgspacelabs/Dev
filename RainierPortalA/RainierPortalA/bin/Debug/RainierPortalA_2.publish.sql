/*
Deployment script for RainierPortalA

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "RainierPortalA"
:setvar DefaultFilePrefix "RainierPortalA"
:setvar DefaultDataPath "D:\SQLDATA16\"
:setvar DefaultLogPath "E:\SQLLOG16\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Rename refactoring operation with key 42202ab8-9a2e-4334-9750-9cc3aa35215c is skipped, element [dbo].[Organization].[Id] (SqlSimpleColumn) will not be renamed to OrganizationID';


GO
PRINT N'Rename refactoring operation with key 43a5038b-079d-4d62-aacc-de81c768a93a is skipped, element [dbo].[Facility].[Id] (SqlSimpleColumn) will not be renamed to FacilityID';


GO
PRINT N'Rename refactoring operation with key 4a0ed6d0-d729-4e0c-ae14-c399abef9d6a is skipped, element [dbo].[Unit].[Id] (SqlSimpleColumn) will not be renamed to UnitID';


GO
PRINT N'Rename refactoring operation with key 20ff398a-6c4d-42f4-af0d-6a241d40b05c is skipped, element [dbo].[Room].[Id] (SqlSimpleColumn) will not be renamed to RoomID';


GO
PRINT N'Creating [dbo].[Bed]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO
CREATE TABLE [dbo].[Bed] (
    [BedID]           INT           IDENTITY (1, 1) NOT NULL,
    [RoomID]          INT           NOT NULL,
    [Name]            VARCHAR (50)  NOT NULL,
    [CreatedDateTime] DATETIME2 (7) NOT NULL,
    CONSTRAINT [PK_Bed_BedID] PRIMARY KEY CLUSTERED ([BedID] ASC)
);


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Creating [dbo].[Facility]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO
CREATE TABLE [dbo].[Facility] (
    [FacilityID]     INT           IDENTITY (1, 1) NOT NULL,
    [OrganizationID] INT           NOT NULL,
    [Name]           VARCHAR (50)  NOT NULL,
    [CreateDateTime] DATETIME2 (7) NOT NULL,
    CONSTRAINT [PK_Facility_FacilityID] PRIMARY KEY CLUSTERED ([FacilityID] ASC)
);


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Creating [dbo].[Organization]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO
CREATE TABLE [dbo].[Organization] (
    [OrganizationID]  INT           IDENTITY (1, 1) NOT NULL,
    [Name]            VARCHAR (50)  NOT NULL,
    [ CreateDateTime] DATETIME2 (7) NOT NULL,
    CONSTRAINT [PK_Organization_OrganizationID] PRIMARY KEY CLUSTERED ([OrganizationID] ASC)
);


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Creating [dbo].[Room]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO
CREATE TABLE [dbo].[Room] (
    [RoomID]          INT           IDENTITY (1, 1) NOT NULL,
    [UnitID]          INT           NOT NULL,
    [Name]            VARCHAR (50)  NOT NULL,
    [CreatedDateTime] DATETIME2 (7) NOT NULL,
    CONSTRAINT [PK_Room_RoomID] PRIMARY KEY CLUSTERED ([RoomID] ASC)
);


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Creating [dbo].[Unit]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO
CREATE TABLE [dbo].[Unit] (
    [UnitID]          INT           IDENTITY (1, 1) NOT NULL,
    [FacilityID]      INT           NOT NULL,
    [Name]            VARCHAR (50)  NOT NULL,
    [CreatedDateTime] DATETIME2 (7) NOT NULL,
    PRIMARY KEY CLUSTERED ([UnitID] ASC)
);


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Creating unnamed constraint on [dbo].[Bed]...';


GO
ALTER TABLE [dbo].[Bed]
    ADD DEFAULT SYSUTCDATETIME() FOR [CreatedDateTime];


GO
PRINT N'Creating unnamed constraint on [dbo].[Room]...';


GO
ALTER TABLE [dbo].[Room]
    ADD DEFAULT SYSUTCDATETIME() FOR [CreatedDateTime];


GO
PRINT N'Creating unnamed constraint on [dbo].[Unit]...';


GO
ALTER TABLE [dbo].[Unit]
    ADD DEFAULT SYSUTCDATETIME() FOR [CreatedDateTime];


GO
PRINT N'Creating [dbo].[FK_Bed_Room_RoomID]...';


GO
ALTER TABLE [dbo].[Bed] WITH NOCHECK
    ADD CONSTRAINT [FK_Bed_Room_RoomID] FOREIGN KEY ([RoomID]) REFERENCES [dbo].[Room] ([RoomID]);


GO
PRINT N'Creating [dbo].[FK_Facility_Organization_OrganizationID]...';


GO
ALTER TABLE [dbo].[Facility] WITH NOCHECK
    ADD CONSTRAINT [FK_Facility_Organization_OrganizationID] FOREIGN KEY ([OrganizationID]) REFERENCES [dbo].[Organization] ([OrganizationID]);


GO
PRINT N'Creating [dbo].[FK_Room_Unit_UnitID]...';


GO
ALTER TABLE [dbo].[Room] WITH NOCHECK
    ADD CONSTRAINT [FK_Room_Unit_UnitID] FOREIGN KEY ([UnitID]) REFERENCES [dbo].[Unit] ([UnitID]);


GO
PRINT N'Creating [dbo].[FK_Unit_Facility_FacilityID]...';


GO
ALTER TABLE [dbo].[Unit] WITH NOCHECK
    ADD CONSTRAINT [FK_Unit_Facility_FacilityID] FOREIGN KEY ([FacilityID]) REFERENCES [dbo].[Facility] ([FacilityID]);


GO
-- Refactoring step to update target server with deployed transaction logs

IF OBJECT_ID(N'dbo.__RefactorLog') IS NULL
BEGIN
    CREATE TABLE [dbo].[__RefactorLog] (OperationKey UNIQUEIDENTIFIER NOT NULL PRIMARY KEY)
    EXEC sp_addextendedproperty N'microsoft_database_tools_support', N'refactoring log', N'schema', N'dbo', N'table', N'__RefactorLog'
END
GO
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '42202ab8-9a2e-4334-9750-9cc3aa35215c')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('42202ab8-9a2e-4334-9750-9cc3aa35215c')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '43a5038b-079d-4d62-aacc-de81c768a93a')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('43a5038b-079d-4d62-aacc-de81c768a93a')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '4a0ed6d0-d729-4e0c-ae14-c399abef9d6a')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('4a0ed6d0-d729-4e0c-ae14-c399abef9d6a')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '20ff398a-6c4d-42f4-af0d-6a241d40b05c')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('20ff398a-6c4d-42f4-af0d-6a241d40b05c')

GO

GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[Bed] WITH CHECK CHECK CONSTRAINT [FK_Bed_Room_RoomID];

ALTER TABLE [dbo].[Facility] WITH CHECK CHECK CONSTRAINT [FK_Facility_Organization_OrganizationID];

ALTER TABLE [dbo].[Room] WITH CHECK CHECK CONSTRAINT [FK_Room_Unit_UnitID];

ALTER TABLE [dbo].[Unit] WITH CHECK CHECK CONSTRAINT [FK_Unit_Facility_FacilityID];


GO
PRINT N'Update complete.';


GO
