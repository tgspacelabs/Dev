<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
    <Product Id="f0395a12-011d-4f95-8bc1-50f4e316c632" Name="InstallMyDatabase" Language="1033" Version="1.0.0.0" Manufacturer="InstallMyDatabase" UpgradeCode="a96c5f50-59ec-42e8-a088-980060826425">
        <Package InstallerVersion="200" Compressed="yes" />

        <Media Id="1" Cabinet="media1.cab" EmbedCab="yes" />

        <!--<?include $(var.SolutionDir)InstallMyDatabase\DatabaseArtifacts.wxi ?>
        <?include $(var.SolutionDir)InstallMyDatabase\VsdbcmdArtifacts.wxi?>-->
        <?include $(var.ProjectDir)\DatabaseArtifacts.wxi ?>
        <?include $(var.ProjectDir)\VsdbcmdArtifacts.wxi?>
        
        <Feature Id="ProductFeature" Title="InstallMyDatabase" Level="1">
            <ComponentRef Id="dacpac"/>
            <ComponentGroupRef Id="SqlPackageComponents"/>
            <!--<ComponentRef Id="DatabaseSqlcmd"/>
            <ComponentRef Id="DatabaseSqldeployment"/>
            <ComponentRef Id="DatabaseSqlsettings"/>
            <ComponentRef Id="DATABASEDBSCHEMA"/>
            <ComponentRef Id="DatabaseDeploymanifest"/>-->
            <!--<ComponentRef Id="MicrosoftSqlTypesDbschema"/>-->
            <!--<ComponentRef Id="PostDeploymentScript"/>
            <ComponentRef Id="PreDeploymentScript"/>-->
            <!--<ComponentRef Id="MicrosoftDataSchema"/>-->
            <!--<ComponentRef Id="MicrosoftDataSchemaScriptDom"/>-->
            <!--<ComponentRef Id="MicrosoftDataSchemaScriptDomSql"/>-->
            <!--<ComponentRef Id="MicrosoftDataSchemaSql"/>-->
            <!--<ComponentRef Id="Vsdbcmd"/>-->
            <!--<ComponentRef Id="VsdbcmdConfig"/>-->
            <!--<ComponentRef Id="DatabaseSchemaProvidersExtensionsXml"/>-->
            <!--<ComponentRef Id="MicrosoftSqlTypes"/>-->
            <!--<ComponentRef Id="RegistryEntries"/>-->
        </Feature>

        <!--Define the dialog to get the Server and Database name information from the user-->
        <UI>
            <Dialog Id="DatabaseInformationDialog" Width="370" Height="270" Title="[ProductName] [Setup]" NoMinimize="yes">
                <Control Id="ServerNameLabel" Type="Text" X="45" Y="73" Width="100" Height="15" TabSkip="no" Text="SQL Instance Name:" />
                <Control Id="ServerNameEdit" Type="Edit" X="45" Y="85" Width="220" Height="18" Property="SERVERNAME" Text="{80}" />
                <Control Id="DatabaseNameLabel" Type="Text" X="45" Y="110" Width="100" Height="15" TabSkip="no" Text="Database Name:" />
                <Control Id="DatabaseNameEdit" Type="Edit" X="45" Y="122" Width="220" Height="18" Property="DATABASENAME" Text="{80}" />
                <Control Id="Back" Type="PushButton" X="180" Y="243" Width="56" Height="17" Text="&amp;Back"/>
                <Control Id="Next" Type="PushButton" X="236" Y="243" Width="56" Height="17" Default="yes" Text="&amp;Next"/>
                <Control Id="Cancel" Type="PushButton" X="304" Y="243" Width="56" Height="17" Cancel="yes" Text="Cancel">
                    <Publish Event="SpawnDialog" Value="CancelDlg">1</Publish>
                </Control>
                <Control Id="BannerBitmap" Type="Bitmap" X="0" Y="0" Width="370" Height="44" TabSkip="no" Text="WixUI_Bmp_Banner" />
                <Control Id="Description" Type="Text" X="25" Y="23" Width="280" Height="15" Transparent="yes" NoPrefix="yes">
                    <Text>”Please enter a SQL instance and database name.”</Text>
                </Control>
                <Control Id="BottomLine" Type="Line" X="0" Y="234" Width="370" Height="0" />
                <Control Id="Title" Type="Text" X="15" Y="6" Width="200" Height="15" Transparent="yes" NoPrefix="yes">
                    <Text>{\WixUI_Font_Title}”SQL instance and database information.”</Text>
                </Control>
                <Control Id="BannerLine" Type="Line" X="0" Y="44" Width="370" Height="0" />
            </Dialog>
        </UI>

        <!--Define the overall user interface - this is based on the WixUI_Mondo dialog set-->
        <UI Id="MyWixUI">
            <TextStyle Id="WixUI_Font_Normal" FaceName="Tahoma" Size="8" />
            <TextStyle Id="WixUI_Font_Bigger" FaceName="Tahoma" Size="12" />
            <TextStyle Id="WixUI_Font_Title" FaceName="Tahoma" Size="9" Bold="yes" />
            <Property Id="DefaultUIFont" Value="WixUI_Font_Normal" />
            <Property Id="WixUI_Mode" Value="Mondo" />
            <DialogRef Id="ErrorDlg" />
            <DialogRef Id="FatalError" />
            <DialogRef Id="FilesInUse" />
            <DialogRef Id="MsiRMFilesInUse" />
            <DialogRef Id="PrepareDlg" />
            <DialogRef Id="ProgressDlg" />
            <DialogRef Id="ResumeDlg" />
            <DialogRef Id="UserExit" />
            <Publish Dialog="ExitDialog" Control="Finish" Event="EndDialog" Value="Return" Order="999">1</Publish>
            <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="LicenseAgreementDlg">1</Publish>
            <Publish Dialog="LicenseAgreementDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg">1</Publish>
            <Publish Dialog="LicenseAgreementDlg" Control="Next" Event="NewDialog" Value="DatabaseInformationDialog" Order="2">LicenseAccepted = "1"</Publish>
            <Publish Dialog="DatabaseInformationDialog" Control="Next" Event="NewDialog" Value="SetupTypeDlg">1</Publish>
            <Publish Dialog="DatabaseInformationDialog" Control="Back" Event="NewDialog" Value="LicenseAgreementDlg">1</Publish>
            <Publish Dialog="SetupTypeDlg" Control="Back" Event="NewDialog" Value="DatabaseInformationDialog">1</Publish>
            <Publish Dialog="SetupTypeDlg" Control="Back" Event="NewDialog" Value="LicenseAgreementDlg">1</Publish>
            <Publish Dialog="SetupTypeDlg" Control="TypicalButton" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
            <Publish Dialog="SetupTypeDlg" Control="CustomButton" Event="NewDialog" Value="CustomizeDlg">1</Publish>
            <Publish Dialog="SetupTypeDlg" Control="CompleteButton" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
            <Publish Dialog="CustomizeDlg" Control="Back" Event="NewDialog" Value="MaintenanceTypeDlg" Order="1">WixUI_InstallMode = "Change"</Publish>
            <Publish Dialog="CustomizeDlg" Control="Back" Event="NewDialog" Value="SetupTypeDlg" Order="2">WixUI_InstallMode = "InstallCustom"</Publish>
            <Publish Dialog="CustomizeDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="CustomizeDlg" Order="1">WixUI_InstallMode = "InstallCustom"</Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="SetupTypeDlg" Order="2">WixUI_InstallMode = "InstallTypical" OR WixUI_InstallMode = "InstallComplete"</Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="CustomizeDlg" Order="3">WixUI_InstallMode = "Change"</Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="MaintenanceTypeDlg" Order="4">WixUI_InstallMode = "Repair" OR WixUI_InstallMode = "Remove"</Publish>
            <Publish Dialog="MaintenanceWelcomeDlg" Control="Next" Event="NewDialog" Value="MaintenanceTypeDlg">1</Publish>
            <Publish Dialog="MaintenanceTypeDlg" Control="ChangeButton" Event="NewDialog" Value="CustomizeDlg">1</Publish>
            <Publish Dialog="MaintenanceTypeDlg" Control="RepairButton" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
            <Publish Dialog="MaintenanceTypeDlg" Control="RemoveButton" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
            <Publish Dialog="MaintenanceTypeDlg" Control="Back" Event="NewDialog" Value="MaintenanceWelcomeDlg">1</Publish>
        </UI>
        <UIRef Id="WixUI_Common" />

        <!--Define the custom action to build the vsdbcmd.exe command line string-->
        <CustomAction Id="LaunchVsdbcmdCommandLine"
                                    Property="LaunchVsdbcmd"
                                    Value="&quot;[#vsdbcmd.exe]&quot; /a:Deploy /cs:&quot;Server=[SERVERNAME];Integrated Security=true;&quot; /dsp:Sql /dd+ /manifest:&quot;[#Database1.deploymanifest]&quot; /p:TargetDatabase=&quot;[DATABASENAME]&quot;"
                                    Execute="immediate"/>
        <!--Define the custom action to execute vsdbcmd.exe-->
        <CustomAction Id="LaunchVsdbcmd" BinaryKey="WixCA" DllEntry="CAQuietExec" Execute="deferred" Return="check" Impersonate="yes"/>
        
        <!--Define when the two custom actions will be executed-->
        <InstallExecuteSequence>
            <Custom Action="LaunchVsdbcmdCommandLine" Before="InstallFiles"/>
            <Custom Action="LaunchVsdbcmd" After="InstallFiles">
                <!--Only run this custom action if a certain feature is being installed-->
                <![CDATA[&ProductFeature=3]]>
            </Custom>
        </InstallExecuteSequence>
        
        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="ProgramFilesFolder">
                <Directory Id="INSTALLLOCATION" Name="MyDatabase">
                    <Directory Id="DACINSTALLFOLDER" Name="SqlPackage" />
                    <Directory Id="Extensions" Name="Extensions">
                        <Directory Id="SqlServer" Name="SqlServer">
                            <Directory Id="__2008" Name="2008">
                                <Directory Id="DbSchemas" Name="DbSchemas">
                                </Directory>
                            </Directory>
                        </Directory>
                    </Directory>
                </Directory>
            </Directory>
        </Directory>
    </Product>
</Wix>
